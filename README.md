# Week 4 | Logging
Logging plays a crucial role in cybersecurity by serving as a comprehensive record of system activities, providing valuable insights into potential security threats and aiding in the early detection and mitigation of cyber attacks. Through the systematic collection and analysis of logs, organizations can track user actions, monitor network traffic, and identify anomalies or suspicious behavior that may indicate a security breach. Additionally, logs play a pivotal role in forensic investigations, enabling cybersecurity professionals to reconstruct events, understand the scope of an incident, and formulate effective response strategies. By maintaining thorough and secure logging practices, organizations can enhance their ability to proactively safeguard their systems, investigate security incidents, and fortify their overall cybersecurity posture.

## Part 1 Creating your Loggly account.
Loggly is a cloud-based log management and analytics service that can allow us to organize, collect, analyze, and visualize logs generated by our web application.

1. Head to [Loggly.com](https://loggly.com) and click "Start Free Trial".

![Loggly start free trial](/lab-writeup-imgs/loggly_start_trial.png)

2. Fill out all the personal and account information. For organization you can just put iSchool, and for subdomain you can put anything (I used info310).

![Create Loggly account](/lab-writeup-imgs/create_loggly_account.png)

3. Once you are in Loggly, on the left sidebar, click Logs > Source Setup.

![Loggly Source Setup](/lab-writeup-imgs/loggly_source_setup.png)

4. On the toolbar at the top of the page, you should see "Customer Tokens". Click that link to view your token.

![Loggly Customer Token](/lab-writeup-imgs/loggly_customer_token.png)

![Loggly Customer Token page](/lab-writeup-imgs/loggly_customer_token_2.png)

You need to copy the customer token shown on this page. This is what will tell our web application to send our logs to the correct Loggly account.

## Part 2: Adding Loggly to our web app.
Now that we have made our Loggly account and retrieved our customer token, we can add it to our web application! Our developers have sent us the code for our  `loggly-logger.php` component:

```
<?php

require __DIR__ . '/../../vendor/autoload.php';

use Monolog\Logger;
use Monolog\Handler\LogglyHandler;
use Monolog\Formatter\LogglyFormatter;

$logglyToken = $_ENV["LOGGLY_TOKEN"];

$logger = new Logger('UW Password Manager');
$logger->pushHandler(new LogglyHandler($logglyToken.'/tag/monolog', Logger::INFO));

$logger->info('Loggly Sending Informational Message');
?>
```

This PHP script uses the Monolog library to send our logs to Loggly:
- First, it includes the autoload file for the Monolog library so that we can automatically load the Monolog classes when we need them in our script:
    ```
    require __DIR__ . '/../../vendor/autoload.php';
    ```

- Next, we import the necessary Monolog classes:
    ```
    use Monolog\Logger;
    use Monolog\Handler\LogglyHandler;
    use Monolog\Formatter\LogglyFormatter;
    ```

- We then get our logging token from our `.env` file and assign it to the `$logglyToken` variable within this script:
    ```
    $logglyToken = $_ENV["LOGGLY_TOKEN"];
    ```
- We then create a new Logger object with the name 'UW Password Manager' and assign it to the `$logger` variable:
    ```
    $logglyToken = $_ENV["LOGGLY_TOKEN"];
    ```

- Next, we configure our Loggly Handler, which is a component used to specifically send log messages to Loggly. We pass in `$logglyToken` for authentication and specify the logging level to INFO (`Logger::INFO`):
    ```
    $logger->pushHandler(new LogglyHandler($logglyToken.'/tag/monolog', Logger::INFO));
    ```

- Finally, we configure what our informational log message is that will be sent with our log. In this case it is 'Loggly Sending Informational Message':
    ```
    $logger->info('Loggly Sending Informational Message');
    ```
Now that we understand how our logger component works, let's go ahead and get started using it!

1. Copy and paste the code for our new loggly component into a php file called `loggly-logger.php`, make sure this file is located in `public > webapp > components > loggly-logger.php`.

2. Paste in your loggly customer token into your .env file, and assign it the `LOGGLY_TOKEN` variable. 

    ```
    LOGGLY_TOKEN: <your_token>
    ```

3. Next, in `docker-compose.yaml` we need to tell our PHP container to read our loggly token environment variable. Let's add a new tag after the `build` header called `environment` assignment our new environment variable to a variable within our PHP container.
    ```
    environment:
        LOGGLY_TOKEN: ${LOGGLY_TOKEN}"
    ```

    Your PHP service should look like this in your compose file:
    ```
    # php
    backend-php-server:
        build:
            dockerfile: ./php/Dockerfile
            target: backend-php-server
        environment:
            LOGGLY_TOKEN: ${LOGGLY_TOKEN}"
        extra_hosts:
            - host.docker.internal:host-gateway
    ```
4. Next, we need to include the logger component in our actual code. That way, it can log certain events of interest. We have already provided you with an example below:

    ```
    include './components/loggly-logger.php';
    ```

    This does exactly what it says, it 'includes' the logger component so that we can use it in our program. Paste this after the `session_start();` line in `login.php`.

    Next, lets add the following line within the else statement. This if-else checks if the login credentials provided by the user are valid against our MySQL database. If they are, they will be redirected to `index.php`, and cookie will be set with their username. If they are invalid, they will get an error that the credentials were invalid. If we add the following line to the else portion, it will log every time a user fails a login attempt. This can be an indication of an attack!

    ```
    $logger->warning("Login failed for username: $username");
    ```

    Let's now check our Loggly account to see our new logs after we fail a login attempt!

    If you click Logs > Log Explorer you should get to a page where you can see all your logs.

    ![log_logexplorer](/lab-writeup-imgs/logs_logexplorer.png)

    At first, you may not see any logs showing up. We need to change our time frame of when we see logs. By default, we will only see logs generated immediately. Click the calendar icon in the top right corner and select an appropriate interval (for example, Last Hour):

    ![change_log_window](/lab-writeup-imgs/change_log_window.png)

    Now we can see all logs in our given time frame. If we click on a log we can see more details. Have one of your lab partners try to log into your web app with the wrong credentials. You should now generate a new log every time a login fails. We can see an example below, where EvilEve could not login!

    ![login_failed](/lab-writeup-imgs/login_failed.png)

## Part 3: What to log?

Now that we have successfully set up loggly, we need to decide what events we want to log. With your group, come up with at least 3 additional events in your password manager that should be logged in loggly, and add the appropriate code to generate logs in loggly. Remember to first 'include' the loggly components (and remember that the pathing to the loggly component is relative!) and add the `$logger` message to those events.

Include screenshots in your lab writeup of the logs you generate (this is required to receive full credit for the assignment)!


## Part 4: EXTRA CREDIT Logging an attack (2pts)!

Now that we have logging set up in multiple places within our password manager, lets also log one of the most basic cybersecurity attacks, brute force attacks! A brute force attack is when an adversary will attempt to brute force a login by trying trying many different potential credentials. This can be as simple as guessing the password or can be more complex involving scripts. 

For this extra credit portion, add some code to the `login.php` script to check if a user is attempting to brute force, and if they are display a warning and block them from attempting further login attempts. You should then also log the brute force attempt to loggly. You will need to submit screenshots of your code to check for brute force attacks as well as screenshots of your Loggly account showing brute force attacks being logged.

You are encouraged to use any resource at your disposal for this portion, including ChatGPT! 
